name: Tests and Coverage

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-coverage:
    name: Tests and Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: true
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11.2"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/dev.txt

      - name: Run tests with coverage
        run: |
          coverage run -m pytest -v --durations=5
          coverage xml

      - name: Save PR branch coverage
        if: github.event_name == 'pull_request'
        id: pr_coverage
        run: |
          PR_COVERAGE=$(coverage report | tail -n 1 | awk '{print $NF}' | tr -d '%')
          echo "PR coverage: $PR_COVERAGE%"
          echo "pr_coverage=$PR_COVERAGE" >> $GITHUB_ENV

      - name: Compare against main branch coverage
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main
          git checkout origin/main
          python -m pip install --upgrade pip
          pip install -r requirements/dev.txt
          coverage run -m pytest --tb=short -q
          MAIN_COVERAGE=$(coverage report | tail -n 1 | awk '{print $NF}' | tr -d '%')
          echo "Main branch coverage: $MAIN_COVERAGE%"
          echo "PR branch coverage: $pr_coverage%"
          if (( $(echo "$pr_coverage < $MAIN_COVERAGE" | bc -l) )); then
            echo "âŒ PR coverage ($pr_coverage%) is lower than main branch ($MAIN_COVERAGE%)"
            exit 1
          fi
          git checkout -

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p public
          coverage-badge -o public/coverage.svg

      - name: Check coverage.svg
        if: github.ref == 'refs/heads/main'
        run: |
          ls -l public
          cat public/coverage.svg || echo "coverage.svg not found"

      - name: Deploy coverage badge to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          destination_dir: coverage
